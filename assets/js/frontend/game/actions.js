// Generated by CoffeeScript 1.10.0
(function() {
  var backgroundTapped, constants, displayCards, globalVariables, hideLeftPlayer, leaveRoom, lowerScore, pass, playSelectedCards, raiseScore, sendGetReadyMessage, setScore, settleCoveredCards, showCallScorePanel, showCoveredCards, showPlayer1Info, showPlayer2Info, showPlayer3Info, surrender, tapDownOnSprite, tapUp, toolbox;

  constants = require('./constants.js');

  globalVariables = require('./globalVariables.js');

  toolbox = require('./toolbox.js');

  displayCards = function(array) {
    var cardName, cardSprite, i, j, k, l, leftMargin, ref, ref1, ref2, results, spritesShouldBeRemoved;
    leftMargin = (globalVariables.screenWidth - (Math.floor(globalVariables.scaledCardWidth / 4) * array.length + Math.floor(3 * globalVariables.scaledCardWidth / 4))) / 2;
    spritesShouldBeRemoved = [];
    if (globalVariables.cardsAtHand.children.length > 0) {
      for (i = j = 0, ref = globalVariables.cardsAtHand.children.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        spritesShouldBeRemoved.push(globalVariables.cardsAtHand.children[i]);
      }
      for (i = k = 0, ref1 = spritesShouldBeRemoved.length; 0 <= ref1 ? k < ref1 : k > ref1; i = 0 <= ref1 ? ++k : --k) {
        globalVariables.cardsAtHand.remove(spritesShouldBeRemoved[i]);
      }
    }
    results = [];
    for (i = l = 0, ref2 = array.length; 0 <= ref2 ? l < ref2 : l > ref2; i = 0 <= ref2 ? ++l : --l) {
      cardName = toolbox.getCardName(array[i]);
      cardSprite = globalVariables.cardsAtHand.create(leftMargin + i * Math.floor(globalVariables.scaledCardWidth / 4), globalVariables.screenHeight - globalVariables.scaledCardHeight - constants.MARGIN, cardName);
      cardSprite.scale.setTo(globalVariables.scaleWidthRatio, globalVariables.scaleHeightRatio);
      cardSprite.isSelected = false;
      cardSprite.inputEnabled = true;
      cardSprite.index = i;
      cardSprite.value = array[i];
      cardSprite.input.useHandCursor = true;
      cardSprite.events.onInputDown.add(tapDownOnSprite, this);
      results.push(cardSprite.events.onInputUp.add(tapUp, this));
    }
    return results;
  };

  showCoveredCards = function() {
    var cardName, coveredCard, coveredCardsStage, i, j, ref, stageHeight, stageWidth;
    if (!globalVariables.isShowingCoveredCards) {
      stageWidth = 11 * globalVariables.scaledCardWidth / 4 + 2 * constants.MARGIN;
      stageHeight = globalVariables.scaledCardHeight + 2 * constants.MARGIN;
      coveredCardsStage = globalVariables.coveredCards.create(globalVariables.screenWidth / 2 - stageWidth / 2, globalVariables.screenHeight / 2 - stageHeight / 2, 'stageBackground');
      coveredCardsStage.alpha = 0.3;
      coveredCardsStage.width = stageWidth;
      coveredCardsStage.height = stageHeight;
      for (i = j = 0, ref = globalVariables.coveredCards.indexes.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        cardName = toolbox.getCardName(globalVariables.coveredCards.indexes[i]);
        coveredCard = globalVariables.coveredCards.create(coveredCardsStage.x + constants.MARGIN + i * globalVariables.scaledCardWidth / 4, coveredCardsStage.y + constants.MARGIN, cardName);
        coveredCard.scale.setTo(globalVariables.scaleWidthRatio, globalVariables.scaleHeightRatio);
      }
      return globalVariables.isShowingCoveredCards = true;
    }
  };

  tapUp = function(sprite, pointer) {
    var i, j, k, l, ref, ref1, ref2, ref3, ref4, results, results1;
    if (pointer.x >= globalVariables.cardsAtHand.children[0].x && pointer.x <= (globalVariables.cardsAtHand.children[globalVariables.cardsAtHand.children.length - 1].x + globalVariables.cardsAtHand.children[globalVariables.cardsAtHand.children.length - 1].width) && pointer.y >= globalVariables.cardsAtHand.children[0].y && pointer.y <= (globalVariables.cardsAtHand.children[0].y + globalVariables.cardsAtHand.children[0].height)) {
      globalVariables.endSwipeCardIndex = -1;
      for (i = j = 0, ref = globalVariables.cardsAtHand.children.length - 1; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        if (pointer.x >= globalVariables.cardsAtHand.children[i].x && pointer.x <= globalVariables.cardsAtHand.children[i + 1].x) {
          globalVariables.endSwipeCardIndex = i;
          break;
        }
      }
      if (globalVariables.endSwipeCardIndex === -1) {
        globalVariables.endSwipeCardIndex = globalVariables.cardsAtHand.children.length - 1;
      }
      if (globalVariables.startSwipeCardIndex <= globalVariables.endSwipeCardIndex) {
        results = [];
        for (i = k = ref1 = globalVariables.startSwipeCardIndex, ref2 = globalVariables.endSwipeCardIndex + 1; ref1 <= ref2 ? k < ref2 : k > ref2; i = ref1 <= ref2 ? ++k : --k) {
          results.push(toolbox.toggleCardSelection(globalVariables.cardsAtHand.children[i]));
        }
        return results;
      } else {
        results1 = [];
        for (i = l = ref3 = globalVariables.endSwipeCardIndex, ref4 = globalVariables.startSwipeCardIndex + 1; ref3 <= ref4 ? l < ref4 : l > ref4; i = ref3 <= ref4 ? ++l : --l) {
          results1.push(toolbox.toggleCardSelection(globalVariables.cardsAtHand.children[i]));
        }
        return results1;
      }
    }
  };

  tapDownOnSprite = function(sprite, pointer) {
    return globalVariables.startSwipeCardIndex = sprite.index;
  };

  hideLeftPlayer = function(username) {
    if (username === globalVariables.player1Username.text) {
      globalVariables.user1Avatar.destroy();
      globalVariables.player1Username.destroy();
      return globalVariables.player1IsMakerText.destroy();
    } else if (username === globalVariables.player2Username.text) {
      globalVariables.user2Avatar.destroy();
      globalVariables.player2Username.destroy();
      return globalVariables.player2IsMakerText.destroy();
    } else if (username === globalVariables.player3Username.text) {
      globalVariables.user3Avatar.destroy();
      globalVariables.player3Username.destroy();
      return globalVariables.player3IsMakerText.destroy();
    }
  };

  backgroundTapped = function() {
    var i, j, k, l, ref, ref1, results, spritesShouldBeRemoved;
    if (globalVariables.isShowingCoveredCards) {
      spritesShouldBeRemoved = [];
      for (i = j = 1; j < 10; i = ++j) {
        spritesShouldBeRemoved.push(globalVariables.coveredCards.children[i]);
      }
      for (i = k = 0, ref = spritesShouldBeRemoved.length; 0 <= ref ? k < ref : k > ref; i = 0 <= ref ? ++k : --k) {
        globalVariables.coveredCards.remove(spritesShouldBeRemoved[i]);
      }
      return globalVariables.isShowingCoveredCards = false;
    } else {
      results = [];
      for (i = l = 0, ref1 = globalVariables.cardsAtHand.children.length; 0 <= ref1 ? l < ref1 : l > ref1; i = 0 <= ref1 ? ++l : --l) {
        if (globalVariables.cardsAtHand.children[i].isSelected) {
          results.push(toolbox.toggleCardSelection(globalVariables.cardsAtHand.children[i]));
        } else {
          results.push(void 0);
        }
      }
      return results;
    }
  };

  playSelectedCards = function() {
    var i, j, k, l, leftMargin, numOfCardsLeft, ref, ref1, ref2, selectedCards, valuesOfCurrentUserPlayedCards;
    selectedCards = [];
    valuesOfCurrentUserPlayedCards = [];
    for (i = j = 0, ref = globalVariables.cardsAtHand.children.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
      if (globalVariables.cardsAtHand.children[i].isSelected) {
        selectedCards.push(globalVariables.cardsAtHand.children[i]);
        valuesOfCurrentUserPlayedCards.push(globalVariables.cardsAtHand.children[i].value);
      }
    }
    if (selectedCards.length === 0) {
      return;
    }
    for (i = k = 0, ref1 = selectedCards.length; 0 <= ref1 ? k < ref1 : k > ref1; i = 0 <= ref1 ? ++k : --k) {
      globalVariables.cardsAtHand.remove(selectedCards[i]);
    }
    numOfCardsLeft = globalVariables.cardsAtHand.children.length;
    leftMargin = (globalVariables.screenWidth - (Math.floor(globalVariables.scaledCardWidth / 4) * numOfCardsLeft + Math.floor(3 * globalVariables.scaledCardWidth / 4))) / 2;
    for (i = l = 0, ref2 = globalVariables.cardsAtHand.children.length; 0 <= ref2 ? l < ref2 : l > ref2; i = 0 <= ref2 ? ++l : --l) {
      globalVariables.cardsAtHand.children[i].x = leftMargin + i * Math.floor(globalVariables.scaledCardWidth / 4);
      globalVariables.cardsAtHand.children[i].index = i;
    }
    return toolbox.showPlayedCardsForUser(0, valuesOfCurrentUserPlayedCards);
  };

  showPlayer1Info = function(game, username) {
    globalVariables.user1Avatar = game.add.sprite(globalVariables.screenWidth - constants.AVATAR_SIZE - constants.MARGIN, game.world.centerY - constants.AVATAR_SIZE / 2, 'avatar');
    globalVariables.user1Avatar.width /= 2;
    globalVariables.user1Avatar.height /= 2;
    globalVariables.player1IsMakerText = game.add.text(globalVariables.screenWidth - constants.AVATAR_SIZE - constants.MARGIN, game.world.centerY - constants.AVATAR_SIZE / 2, '', constants.RED_TEXT_STYLE);
    globalVariables.player1Username = game.add.text(globalVariables.screenWidth - constants.AVATAR_SIZE - constants.MARGIN, game.world.centerY + constants.AVATAR_SIZE / 2 + constants.MARGIN, username, constants.TEXT_STYLE);
    return globalVariables.player1Username.setTextBounds(0, 0, constants.AVATAR_SIZE, 25);
  };

  showPlayer2Info = function(game, username) {
    globalVariables.user2Avatar = game.add.sprite(game.world.centerX - constants.AVATAR_SIZE / 2, constants.MARGIN, 'avatar');
    globalVariables.user2Avatar.width /= 2;
    globalVariables.player2IsMakerText = game.add.text(game.world.centerX - constants.AVATAR_SIZE / 2, constants.MARGIN, '', constants.RED_TEXT_STYLE);
    globalVariables.user2Avatar.height /= 2;
    globalVariables.player2Username = game.add.text(game.world.centerX - constants.AVATAR_SIZE / 2, constants.AVATAR_SIZE + 2 * constants.MARGIN, username, constants.TEXT_STYLE);
    return globalVariables.player2Username.setTextBounds(0, 0, constants.AVATAR_SIZE, 25);
  };

  showPlayer3Info = function(game, username) {
    globalVariables.user3Avatar = game.add.sprite(constants.MARGIN, game.world.centerY - constants.AVATAR_SIZE / 2, 'avatar');
    globalVariables.user3Avatar.width /= 2;
    globalVariables.user3Avatar.height /= 2;
    globalVariables.player3IsMakerText = game.add.text(constants.MARGIN, game.world.centerY - constants.AVATAR_SIZE / 2, '', constants.RED_TEXT_STYLE);
    globalVariables.player3Username = game.add.text(constants.MARGIN, game.world.centerY + constants.AVATAR_SIZE / 2 + constants.MARGIN, username, constants.TEXT_STYLE);
    return globalVariables.player3Username.setTextBounds(0, 0, constants.AVATAR_SIZE, 25);
  };

  sendGetReadyMessage = function() {
    var csrfToken;
    csrfToken = document.getElementsByName('csrf-token')[0].content;
    return io.socket.post('/get_ready', {
      _csrf: csrfToken,
      userId: globalVariables.userId,
      loginToken: globalVariables.loginToken
    }, function(resData, jwres) {
      if (jwres.statusCode === 200) {
        globalVariables.prepareButton.visible = false;
        globalVariables.leaveButton.visible = false;
        return globalVariables.meStatusText.text = 'Ready';
      } else {
        return console.log(jwres);
      }
    });
  };

  leaveRoom = function() {
    var csrfToken;
    csrfToken = document.getElementsByName('csrf-token')[0].content;
    return io.socket.post('/leave_room', {
      _csrf: csrfToken,
      userId: globalVariables.userId,
      loginToken: globalVariables.loginToken
    }, function(resData, jwres) {
      if (jwres.statusCode === 200) {
        return window.location.href = '/';
      }
    });
  };

  raiseScore = function() {
    var aimedScores, currentSetScores;
    aimedScores = parseInt(globalVariables.textOfAimedScores.text);
    currentSetScores = parseInt(globalVariables.callScoreStage.children[2].text);
    if (currentSetScores < (aimedScores - 5)) {
      currentSetScores += 5;
      return globalVariables.callScoreStage.children[2].text = '' + currentSetScores;
    }
  };

  showCallScorePanel = function(game, currentScore) {
    var background, currentScoreText, lowerScoreButton, passButton, raiseScoreButton, setScoreButton, stageHeight, stageWidth;
    globalVariables.callScoreStage = game.add.group();
    stageWidth = 11 * globalVariables.scaledCardWidth / 4 + 2 * constants.MARGIN;
    stageHeight = globalVariables.scaledCardHeight + 2 * constants.MARGIN;
    background = globalVariables.callScoreStage.create(globalVariables.screenWidth / 2 - stageWidth / 2, globalVariables.screenHeight / 2 - stageHeight / 2, 'stageBackground');
    background.alpha = 0.3;
    background.width = stageWidth;
    background.height = stageHeight;
    raiseScoreButton = game.add.button(game.world.centerX - constants.ROUND_BUTTON_SIZE / 2 - constants.ROUND_BUTTON_SIZE - constants.MARGIN, game.world.centerY - stageHeight / 2 + constants.MARGIN, 'raiseScoreButton', raiseScore, this, 1, 0, 1, 0);
    globalVariables.callScoreStage.add(raiseScoreButton);
    currentScoreText = game.add.text(game.world.centerX - constants.ROUND_BUTTON_SIZE / 2, game.world.centerY - stageHeight / 2 + constants.MARGIN, '' + currentScore - 5, constants.LARGE_TEXT_STYLE);
    currentScoreText.setTextBounds(0, 0, constants.ROUND_BUTTON_SIZE, constants.ROUND_BUTTON_SIZE);
    globalVariables.callScoreStage.add(currentScoreText);
    lowerScoreButton = game.add.button(game.world.centerX + constants.ROUND_BUTTON_SIZE / 2 + constants.MARGIN, game.world.centerY - stageHeight / 2 + constants.MARGIN, 'lowerScoreButton', lowerScore, this, 1, 0, 1, 0);
    globalVariables.callScoreStage.add(lowerScoreButton);
    setScoreButton = game.add.button(game.world.centerX - constants.BUTTON_WIDTH - constants.MARGIN / 2, game.world.centerY + constants.ROUND_BUTTON_SIZE / 2, 'setScoreButton', setScore, this, 1, 0, 1, 0);
    globalVariables.callScoreStage.add(setScoreButton);
    passButton = game.add.button(game.world.centerX + constants.MARGIN / 2, game.world.centerY + constants.ROUND_BUTTON_SIZE / 2, 'passButton', pass, this, 1, 0, 1, 0);
    return globalVariables.callScoreStage.add(passButton);
  };

  lowerScore = function() {
    var aimedScores, currentSetScores;
    aimedScores = parseInt(globalVariables.textOfAimedScores.text);
    currentSetScores = parseInt(globalVariables.callScoreStage.children[2].text);
    if (currentSetScores > 5) {
      currentSetScores -= 5;
      return globalVariables.callScoreStage.children[2].text = '' + currentSetScores;
    }
  };

  setScore = function() {
    var aimedScore, csrfToken;
    csrfToken = document.getElementsByName('csrf-token')[0].content;
    aimedScore = parseInt(globalVariables.callScoreStage.children[2].text);
    return io.socket.post('/set_score', {
      score: aimedScore,
      roomName: globalVariables.roomName,
      _csrf: csrfToken,
      userId: globalVariables.userId,
      loginToken: globalVariables.loginToken
    }, function(resData, jwres) {
      if (jwres.statusCode === 200) {
        globalVariables.callScoreStage.destroy(true, false);
        return globalVariables.meStatusText.text = '' + aimedScore;
      }
    });
  };

  pass = function() {
    var csrfToken;
    csrfToken = document.getElementsByName('csrf-token')[0].content;
    return io.socket.post('/pass', {
      _csrf: csrfToken,
      userId: globalVariables.userId,
      loginToken: globalVariables.loginToken,
      username: globalVariables.username,
      roomName: globalVariables.roomName
    }, function(resData, jwres) {
      if (jwres.statusCode === 200) {
        globalVariables.callScoreStage.destroy(true, false);
        return globalVariables.meStatusText.text = '不要';
      }
    });
  };

  surrender = function() {
    var csrfToken;
    csrfToken = document.getElementsByName('csrf-token')[0].content;
    globalVariables.prepareButton.visible = true;
    globalVariables.leaveButton.visible = true;
    globalVariables.meStatusText.text = '你输了';
    globalVariables.surrenderButton.visible = false;
    return globalVariables.settleCoveredCardsButton.visible = false;
  };

  settleCoveredCards = function() {
    var coveredCardsIcon, i, index, j, k, ref, ref1, valuesOfSelectedCoveredCards;
    valuesOfSelectedCoveredCards = [];
    for (i = j = 0, ref = globalVariables.cardsAtHand.children.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
      if (globalVariables.cardsAtHand.children[i].isSelected) {
        valuesOfSelectedCoveredCards.push(globalVariables.cardsAtHand.children[i].value);
      }
    }
    if (valuesOfSelectedCoveredCards.length !== 8) {
      return;
    }
    for (i = k = 0, ref1 = valuesOfSelectedCoveredCards.length; 0 <= ref1 ? k < ref1 : k > ref1; i = 0 <= ref1 ? ++k : --k) {
      index = globalVariables.cardsAtHand.indexes.indexOf(valuesOfSelectedCoveredCards[i]);
      globalVariables.cardsAtHand.indexes.splice(index, 1);
    }
    displayCards(globalVariables.cardsAtHand.indexes);
    coveredCardsIcon = globalVariables.coveredCards.create(constants.MARGIN, constants.MARGIN, 'back');
    coveredCardsIcon.scale.setTo(globalVariables.scaleWidthRatio, globalVariables.scaleHeightRatio);
    coveredCardsIcon.inputEnabled = true;
    globalVariables.coveredCards.indexes = valuesOfSelectedCoveredCards;
    return coveredCardsIcon.events.onInputDown.add(showCoveredCards, this);
  };

  module.exports = {
    displayCards: displayCards,
    showCoveredCards: showCoveredCards,
    tapUp: tapUp,
    tapDownOnSprite: tapDownOnSprite,
    backgroundTapped: backgroundTapped,
    playSelectedCards: playSelectedCards,
    showPlayer1Info: showPlayer1Info,
    showPlayer2Info: showPlayer2Info,
    showPlayer3Info: showPlayer3Info,
    hideLeftPlayer: hideLeftPlayer,
    sendGetReadyMessage: sendGetReadyMessage,
    leaveRoom: leaveRoom,
    showCallScorePanel: showCallScorePanel,
    raiseScore: raiseScore,
    lowerScore: lowerScore,
    setScore: setScore,
    pass: pass,
    surrender: surrender,
    settleCoveredCards: settleCoveredCards
  };

}).call(this);
