// Generated by CoffeeScript 1.10.0
(function() {
  var actions, constants, getRoomInfo, globalVariables, setPlayerStatusTextForOneUserAndClearStatusTextForOthers, socketEventHandler, toolbox;

  constants = require('./constants.js');

  actions = require('./actions.js');

  toolbox = require('./toolbox.js');

  globalVariables = require('./globalVariables.js');


  /*
  Set status text for one player and clear status text for all other players
  @param: username                                player username whose status text needs to be updated
  @param: statusText                              the status text string
  @return: -
   */

  setPlayerStatusTextForOneUserAndClearStatusTextForOthers = function(username, statusText) {
    globalVariables.meStatusText.text = '';
    globalVariables.player1StatusText.text = '';
    globalVariables.player2StatusText.text = '';
    globalVariables.player3StatusText.text = '';
    if (username === globalVariables.username) {
      return globalVariables.meStatusText.text = statusText;
    } else if (username === globalVariables.player1Username.text) {
      return globalVariables.player1StatusText.text = statusText;
    } else if (username === globalVariables.player2Username.text) {
      return globalVariables.player2StatusText.text = statusText;
    } else if (username === globalVariables.player3Username.text) {
      return globalVariables.player3StatusText.text = statusText;
    }
  };

  getRoomInfo = function(game) {
    return io.socket.get('/get_room_info', {
      userId: globalVariables.userId,
      loginToken: globalVariables.loginToken
    }, function(resData, jwres) {
      var diff, i, j, k, readyPlayers, ref, ref1, ref2, results, seatIndexOfCurrentUser, seats, usernames;
      if (jwres.statusCode === 200) {
        globalVariables.textOfRoomName.text = resData.roomName;
        usernames = resData.usernames;
        seats = [resData.seats.one, resData.seats.two, resData.seats.three, resData.seats.four];
        seatIndexOfCurrentUser = seats.indexOf(globalVariables.username);
        for (i = j = ref = seatIndexOfCurrentUser + 1, ref1 = seatIndexOfCurrentUser + 4; ref <= ref1 ? j < ref1 : j > ref1; i = ref <= ref1 ? ++j : --j) {
          if (seats[i % 4] !== '') {
            diff = i - seatIndexOfCurrentUser;
            switch (diff) {
              case 1 || -3:
                actions.showPlayer1Info(game, seats[i % 4]);
                break;
              case 2 || -2:
                actions.showPlayer2Info(game, seats[i % 4]);
                break;
              case 3 || -1:
                actions.showPlayer3Info(game, seats[i % 4]);
            }
          }
        }
        readyPlayers = resData.readyPlayers;
        results = [];
        for (i = k = 0, ref2 = readyPlayers.length; 0 <= ref2 ? k < ref2 : k > ref2; i = 0 <= ref2 ? ++k : --k) {
          if (globalVariables.player1Username) {
            if (readyPlayers[i] === globalVariables.player1Username.text) {
              globalVariables.player1StatusText.text = 'Ready';
            }
          }
          if (globalVariables.player2Username) {
            if (readyPlayers[i] === globalVariables.player2Username.text) {
              globalVariables.player2StatusText.text = 'Ready';
            }
          }
          if (globalVariables.player3Username) {
            if (readyPlayers[i] === globalVariables.player3Username.text) {
              results.push(globalVariables.player3StatusText.text = 'Ready');
            } else {
              results.push(void 0);
            }
          } else {
            results.push(void 0);
          }
        }
        return results;
      }
    });
  };

  socketEventHandler = function(game) {
    io.socket.on('newPlayerJoined', function(data) {
      var diff, newPlayerUsername, seatIndexOfCurrentUser, seatIndexOfNewPlayer, seats;
      newPlayerUsername = data.newPlayer;
      seats = [data.seats.one, data.seats.two, data.seats.three, data.seats.four];
      seatIndexOfCurrentUser = seats.indexOf(globalVariables.username);
      seatIndexOfNewPlayer = seats.indexOf(newPlayerUsername);
      diff = seatIndexOfNewPlayer - seatIndexOfCurrentUser;
      if (diff === 1 || diff === -3) {
        actions.showPlayer1Info(game, newPlayerUsername);
      }
      if (diff === 2 || diff === -2) {
        actions.showPlayer2Info(game, newPlayerUsername);
      }
      if (diff === 3 || diff === -1) {
        actions.showPlayer3Info(game, newPlayerUsername);
      }
    });
    io.socket.on('playerLeavedRoom', function(data) {
      var leftUsername;
      leftUsername = data.username;
      return actions.hideLeftPlayer(leftUsername);
    });
    io.socket.on('playerReady', function(data) {
      var readyUsername;
      readyUsername = data.username;
      if (globalVariables.player1Username) {
        if (readyUsername === globalVariables.player1Username.text) {
          globalVariables.player1StatusText.text = 'Ready';
        }
      }
      if (globalVariables.player2Username) {
        if (readyUsername === globalVariables.player2Username.text) {
          globalVariables.player2StatusText.text = 'Ready';
        }
      }
      if (globalVariables.player3Username) {
        if (readyUsername === globalVariables.player3Username.text) {
          return globalVariables.player3StatusText.text = 'Ready';
        }
      }
    });
    io.socket.on('cardsSent', function(data) {
      var usernameToCallScore;
      globalVariables.cardsAtHand.values = data.cards;
      globalVariables.cardsAtHand.values = data.cards;
      usernameToCallScore = data.usernameToCallScore;
      globalVariables.cardsAtHand.values = toolbox.sortCards(globalVariables.cardsAtHand.values);
      actions.displayCards(globalVariables.cardsAtHand.values);
      globalVariables.meStatusText.text = '';
      globalVariables.player1StatusText.text = '';
      globalVariables.player2StatusText.text = '';
      globalVariables.player3StatusText.text = '';
      globalVariables.textOfAimedScores.text = '80';
      globalVariables.textOfCurrentScores.text = '0';
      if (usernameToCallScore === globalVariables.username) {
        return actions.showCallScorePanel(game, 80);
      } else {
        if (usernameToCallScore === globalVariables.player1Username.text) {
          return globalVariables.player1StatusText.text = '叫分中...';
        } else if (usernameToCallScore === globalVariables.player2Username.text) {
          return globalVariables.player2StatusText.text = '叫分中...';
        } else if (usernameToCallScore === globalVariables.player3Username.text) {
          return globalVariables.player3StatusText.text = '叫分中...';
        }
      }
    });
    io.socket.on('userCalledScore', function(data) {
      var currentAimedScore, usernameCalledScore, usernameToCallScore;
      currentAimedScore = data.currentAimedScore;
      usernameCalledScore = data.usernameCalledScore;
      usernameToCallScore = data.usernameToCallScore;
      globalVariables.textOfAimedScores.text = '' + currentAimedScore;
      if (usernameToCallScore === globalVariables.username) {
        globalVariables.meStatusText.text = '叫分中...';
        actions.showCallScorePanel(game, currentAimedScore);
      } else if (usernameToCallScore === globalVariables.player1Username.text) {
        globalVariables.player1StatusText.text = '叫分中...';
      } else if (usernameToCallScore === globalVariables.player2Username.text) {
        globalVariables.player2StatusText.text = '叫分中...';
      } else if (usernameToCallScore === globalVariables.player3Username.text) {
        globalVariables.player3StatusText.text = '叫分中...';
      }
      if (usernameCalledScore === globalVariables.player1Username.text) {
        return globalVariables.player1StatusText.text = currentAimedScore + '分';
      } else if (usernameCalledScore === globalVariables.player2Username.text) {
        return globalVariables.player2StatusText.text = currentAimedScore + '分';
      } else if (usernameCalledScore === globalVariables.player3Username.text) {
        return globalVariables.player3StatusText.text = currentAimedScore + '分';
      }
    });
    io.socket.on('userPassed', function(data) {
      var currentAimedScore, passedUser, usernameToCallScore;
      passedUser = data.passedUser;
      usernameToCallScore = data.usernameToCallScore;
      currentAimedScore = data.aimedScore;
      if (passedUser === globalVariables.player1Username.text) {
        globalVariables.player1StatusText.text = '不要';
      } else if (passedUser === globalVariables.player2Username.text) {
        globalVariables.player2StatusText.text = '不要';
      } else if (passedUser === globalVariables.player3Username.text) {
        globalVariables.player3StatusText.text = '不要';
      }
      if (usernameToCallScore === globalVariables.username) {
        return actions.showCallScorePanel(game, currentAimedScore);
      }
    });
    io.socket.on('makerSettled', function(data) {
      var aimedScore, coveredCards, makerUsername;
      aimedScore = data.aimedScore;
      makerUsername = data.makerUsername;
      globalVariables.textOfAimedScores.text = aimedScore + '分';
      if (makerUsername === globalVariables.player1Username.text) {
        globalVariables.player1IsMakerIcon.visible = true;
      } else if (makerUsername === globalVariables.player2Username.text) {
        globalVariables.player2IsMakerIcon.visible = true;
      } else if (makerUsername === globalVariables.player3Username.text) {
        globalVariables.player3IsMakerIcon.visible = true;
      }
      if (makerUsername === globalVariables.username) {
        coveredCards = data.coveredCards;
        globalVariables.cardsAtHand.values = globalVariables.cardsAtHand.values.concat(coveredCards);
        globalVariables.cardsAtHand.values = toolbox.sortCards(globalVariables.cardsAtHand.values);
        actions.displayCards(globalVariables.cardsAtHand.values);
        globalVariables.surrenderButton.visible = true;
        globalVariables.settleCoveredCardsButton.visible = true;
        globalVariables.settleCoveredCardsButton.inputEnabled = false;
        globalVariables.settleCoveredCardsButton.setFrames(2, 2, 2);
      }
      globalVariables.gameStatus = constants.GAME_STATUS_SETTLING_COVERED_CARDS;
      return setPlayerStatusTextForOneUserAndClearStatusTextForOthers(makerUsername, '庄家埋底中...');
    });
    io.socket.on('finishedSettlingCoveredCards', function(data) {
      var makerUsername;
      makerUsername = data.maker;
      return setPlayerStatusTextForOneUserAndClearStatusTextForOthers(makerUsername, '庄家选主中...');
    });
    io.socket.on('mainSuitChosen', function(data) {
      var makerUsername;
      globalVariables.gameStatus = constants.GAME_STATUS_PLAYING;
      globalVariables.mainSuit = data.mainSuit;
      globalVariables.cardValueRanks = toolbox.getRanksForMainSuitCards(globalVariables.mainSuit);
      makerUsername = data.maker;
      globalVariables.iconOfMainSuit.frame = globalVariables.mainSuit;
      setPlayerStatusTextForOneUserAndClearStatusTextForOthers(makerUsername, '出牌中...');
      globalVariables.cardsAtHand.values = toolbox.sortCardsAfterMainSuitSettled(globalVariables.cardsAtHand.values, globalVariables.mainSuit);
      return actions.displayCards(globalVariables.cardsAtHand.values);
    });
    io.socket.on('cardPlayed', function(data) {
      var n, nextPlayerUsername, playedCardValues, usernamePlayedCards;
      usernamePlayedCards = data.playerName;
      playedCardValues = data.playedCardValues;
      globalVariables.firstlyPlayedCardValuesForCurrentRound = data.firstlyPlayedCardValues;
      nextPlayerUsername = data.nextPlayerUsername;
      n = -1;
      if (usernamePlayedCards === globalVariables.username) {
        globalVariables.meHistoricalPlayedCardValues.push(playedCardValues);
      } else if (usernamePlayedCards === globalVariables.player1Username.text) {
        globalVariables.player1HistoricalPlayedCardValues.push(playedCardValues);
        n = 1;
      } else if (usernamePlayedCards === globalVariables.player2Username.text) {
        globalVariables.player2HistoricalPlayedCardValues.push(playedCardValues);
        n = 2;
      } else if (usernamePlayedCards === globalVariables.player3Username.text) {
        globalVariables.player3HistoricalPlayedCardValues.push(playedCardValues);
        n = 3;
      }
      if (n !== -1) {
        actions.showPlayedCardsForUser(n, playedCardValues, true);
      }
      if (nextPlayerUsername === globalVariables.username) {
        globalVariables.playCardsButton.inputEnabled = false;
        globalVariables.playCardsButton.setFrames(2, 2, 2);
        globalVariables.playCardsButton.visible = true;
      }
      return setPlayerStatusTextForOneUserAndClearStatusTextForOthers(nextPlayerUsername, '出牌中...');
    });
    return io.socket.on('roundFinished', function(data) {
      var n, playedCardValues, scoresEarned, usernamePlayedCards, usernameWithLargestCardsForCurrentRound;
      usernamePlayedCards = data.lastPlayerName;
      playedCardValues = data.playedCardValues;
      scoresEarned = data.scoresEarned;
      usernameWithLargestCardsForCurrentRound = data.usernameWithLargestCardsForCurrentRound;
      n = -1;
      if (usernamePlayedCards === globalVariables.username) {
        globalVariables.meHistoricalPlayedCardValues.push(playedCardValues);
      } else if (usernamePlayedCards === globalVariables.player1Username.text) {
        globalVariables.player1HistoricalPlayedCardValues.push(playedCardValues);
        n = 1;
      } else if (usernamePlayedCards === globalVariables.player2Username.text) {
        globalVariables.player2HistoricalPlayedCardValues.push(playedCardValues);
        n = 2;
      } else if (usernamePlayedCards === globalVariables.player3Username.text) {
        globalVariables.player3HistoricalPlayedCardValues.push(playedCardValues);
        n = 3;
      }
      if (n !== -1) {
        actions.showPlayedCardsForUser(n, playedCardValues, true);
      }
      actions.showBigStampForTheLargestPlayedCardsCurrentRound(playedCardValues.length, usernameWithLargestCardsForCurrentRound, game);
      globalVariables.textOfCurrentScores.text = parseInt(globalVariables.textOfCurrentScores.text) + scoresEarned;
      if (scoresEarned !== 0) {
        actions.showEarnedScoreTextWithFadeOutEffect(scoresEarned, game);
      }
      globalVariables.firstlyPlayedCardValuesForCurrentRound = [];
      globalVariables.historicalButton.inputEnabled = true;
      globalVariables.historicalButton.visible = true;
      return setTimeout(function() {
        if (data.shouldGameEnd) {
          return actions.endGame(false, data.gameResults);
        }
        globalVariables.bigSign.destroy();
        globalVariables.currentUserPlayedCards.removeAll();
        globalVariables.user1PlayedCards.removeAll();
        globalVariables.user2PlayedCards.removeAll();
        globalVariables.user3PlayedCards.removeAll();
        if (globalVariables.cardsAtHand.children.length !== 0) {
          if (usernameWithLargestCardsForCurrentRound === globalVariables.username) {
            globalVariables.playCardsButton.inputEnabled = false;
            globalVariables.playCardsButton.setFrames(2, 2, 2);
            globalVariables.playCardsButton.visible = true;
          }
          return setPlayerStatusTextForOneUserAndClearStatusTextForOthers(usernameWithLargestCardsForCurrentRound, '出牌中...');
        }
      }, 2000);
    });
  };

  module.exports = {
    getRoomInfo: getRoomInfo,
    socketEventHandler: socketEventHandler
  };

}).call(this);
